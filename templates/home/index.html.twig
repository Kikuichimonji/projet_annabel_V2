{% extends 'base.html.twig' %}
{% block title %}Accueil{% endblock %}
{% block nav %}

<nav class="uk-navbar-container" uk-navbar>
    <div class="uk-navbar-left">
        <ul class="uk-navbar-nav">
        {% for cabinet in cabinets %}
            {% if cabinet.id == nav %}
                <li class="uk-active">
            {% else %}
                <li>
            {% endif %}
                <a href="{{path("home_detail",{"id":cabinet.id})}}">{{cabinet.libelle}}</a>
            </li>
        {% endfor %}
        </ul>
        {% set error = app.request.query.get("err")%}
    <span id="error">{% if error == 1 %}Ce cabinet n'existe pas{% endif %}</span>
    </div>
    <div >
        <a class="uk-navbar-center" href="{{path("home_detail",{"id":0})}}"><h1>Accueil<h1></a>
    </div>
    {% set class= "" %}
    {% if is_granted('ROLE_ADMIN') %}
        {% set class= "admin" %}
    {% endif %}
    <div class="uk-navbar-right">
        Connecté en tant que : {% if is_granted('ROLE_ADMIN') %}
            <a class="admin" href="{{path("admin_utilisateur")}}"><span uk-icon="pencil"></span></a>
        {% endif %}<span class="username {{class}}"> {{app.user.username}}</span>
         <a href="{{path('app_logout')}}"><span uk-icon="icon:close; ratio: 1.5"></span></a>
    </div>
</nav>
{% endblock %}
{% block body %}
    <a onclick="return checkCabinet()" href="{{path('patient_add',{'idc':nav})}}"><span uk-icon="icon: plus-circle; ratio: 1.5"></span> Ajouter un nouveau patient</a>
    <h2 class="uk-heading-line uk-text-center"><span>Liste des patients ({{patients.getTotalItemCount}})</span></h2>
    {{ form_start(form) }}
        <!--<button type="submit">filtrer</button>-->
    {{ form_end(form) }}
    {% set link = '<a href="{{path(\'patient_edit\',{\'idc\':app.request.attributes.get("_route_params").id,\'id\':patient.id})}}">' %}
    <table class="uk-table-striped uk-table-hover uk-table-small uk-table">
        <thead>
            <tr>
                <th>Nom</th>
                <th>Prenom</th>
                <th>Telephone</th>
                <th>Adresse</th>
                <th>Date de dernière consultation</th>
                {% if is_granted('ROLE_ADMIN') %}
                    <th>Suppression</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for patient in patients %}
            
            <tr class="trClic" id="{{patient.id}}">
                <td><a id="aClic{{patient.id}}" onclick="return checkCabinet()" href="{{path('patient_edit',{'idc':app.request.attributes.get("_route_params").id,'id':patient.id})}}">{{patient.nom}}</a></td>
                <td>{{patient.prenom}}</td>
                <td>{% if is_granted('ROLE_ADMIN') %}
                        {{patient.numFixe}}
                    {% endif %}</td>
                <td>{{patient.adresse ~" "~ patient.codePostal ~" "~ patient.ville}}</td>
                {% if patient.GetLastConsultationDate %}
                    {% set dateConsult =  patient.getLastConsultationDate.getDateConsult.format("d/m/Y") %}
                    {% set tdclass = "" %}
                {% else %}
                    {% set dateConsult =  "Pas de consultation" %}
                    {% set tdclass = "dimTD" %}
                {% endif %}
                    <td class="{{tdclass}}">{{dateConsult}}</td>
                {% if is_granted('ROLE_ADMIN') %}
                    <td id="tdDelete">
                        <a class="admin" href="{{path('patient_delete_cabinet',{'idc':app.request.attributes.get('_route_params').id,'id':patient.id})}}"><span uk-icon="trash"></span></a>
                        <a class="admin" href="{{path('patient_delete_full',{'id':patient.id})}}"><span uk-icon="warning"></span></a>
                    </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
   
    <div class="bootstrap">
        {{ knp_pagination_render(patients) }}
    </div>
{% endblock %}
{% block javascripts %}
    {{parent()}}
    <script>
        function checkCabinet(){
            var classCabinet = document.getElementsByClassName("uk-active") ;
            if(!classCabinet.length)
            {
                document.getElementById("error").innerHTML = "Veuillez selectionner un cabinet"
                return false;
            }
            else
                return true;
        }
        var tr = document.getElementsByClassName("trClic") ;
        [].forEach.call(tr,function(opt){
            opt.addEventListener('click', function (event) {
            if(checkCabinet())
                window.location.href = document.querySelector('#aClic'+opt.id);
            });
        });

       
    </script>

{% endblock %}